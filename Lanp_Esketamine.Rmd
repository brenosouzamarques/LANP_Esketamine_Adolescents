---
title: "Antidepressant effects of esketamine in adolescents with major depressive disorder and suicidal ideation: a case series"
subtitle: Reproducible analysis report
author:
 - Daniela Faria-Guimarães
 - Lucca S. Souza
 - Breno Souza-Marques
 - Flávia Vieria
 - Igor D. Bandeira
 - Samantha S. Silva
 - Aline S. Sampaio
 - Lucas C. Quarantini
output: 
    bookdown::pdf_document2:
      number_sections: false
      toc: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
# Note

This R Markdown file will exactly reproduce our data tidying, transformation, analysis and graphing processes in the R software and produce an illustrative PDF file. Code-only scripts are also available in the Open Science Framework repository for this study, at [https://osf.io/2ujqn/](https://osf.io/2ujqn/). The reproduction of this `markdown` file requires that the dataset available in the OSF repository is located in the same directory of this file, and that the user has the necessary dependencies to create a PDF using the `bookdown` package. Further information is available at the [package website](https://bookdown.org). Please refer to the repository for a detailed description of each variable contained herein. All files in the repository, including this one, are licensed under [CC-BY-4.0](https://creativecommons.org/licenses/by/4.0/).


```{r, warning=F, message=F}
# Required Packages
packages = c("tidyverse", "haven",
             "lsr", "rstatix", "exactRankTests", "boot", "skimr", "kableExtra",
             "patchwork", "RColorBrewer", "ggsci", "car", "printr")
package.check <- lapply(
            packages,
            FUN = function(x) {
                        if (!require(x, character.only = TRUE)) {
                                    install.packages(x)
                                    library(x, character.only = TRUE)
                        }
            }
)
```


# Load and manage dataset
To correctly load the data, place the "dataset.sav" file in the same directory of this R Markdown script.

```{r, warning = F, message = F}
set.seed(252009)

## Read the database
df <- haven::read_sav("Dataset.sav")
df <- haven::zap_formats(df) #remove unnecessary information from columns

```

\newpage
# Assessing distribution and descriptives

## Visualize data distribution at each timepoint

### MADRS total score at baseline
```{r, fig.align='center', out.width= '50%', message = F, warning= F}
car::qqPlot(df$MADRS_pré)
```

### MADRS total score at 24h post-treatment
```{r, fig.align='center', out.width= '50%', message = F, warning= F}
car::qqPlot(df$MADRS_24h)
```

\newpage
### MADRS item 10 score at baseline
```{r, fig.align='center', out.width= '50%', message = F, warning= F}
car::qqPlot(df$Item10_PréMADRS)
```

### MADRS item 10 score at 24h post-treatment
```{r, fig.align='center', out.width= '50%', message = F, warning= F}
car::qqPlot(df$Item10_24hMADRS)
```

\newpage

### MADRS total scores

```{r, warning = F, message = F}
madrs_total <- c(df$MADRS_pré, df$MADRS_24h)
time <- rep(c("baseline", "post"), each = 10)
data_madrs_total <- tibble(time, madrs_total)
data_madrs_total %>% group_by(time) %>% 
  summarise(
  mean = mean(madrs_total),
  sd = sd(madrs_total)
)

```
|
|

---
|
|

### MADRS item 10 scores

```{r}
item_10_total <- c(df$Item10_PréMADRS, df$Item10_24hMADRS)
time <- rep(c("baseline", "post"), each = 10)
data_madrs_total <- tibble(time, item_10_total)
data_madrs_total %>% group_by(time) %>% 
  summarise(
  mean = mean(item_10_total),
  sd = sd(item_10_total)
)
```

\newpage

# T-tests and effect sizes
|
```{r}
### T-test - MADRS Total Scores

t.test(x = df$MADRS_pré,
       y = df$MADRS_24h,
       paired = T) ## do paired sample T-tests


lsr::cohensD(df$MADRS_pré,
             df$MADRS_24h,
             method = "paired") ## calculate Cohen's effect size



```


```{r}
### T-test - MADRS Item 10 scores

t.test(x = df$Item10_PréMADRS,
       y = df$Item10_24hMADRS,
       paired = T)


lsr::cohensD(df$Item10_PréMADRS,
             df$Item10_24hMADRS,
             method = "paired")
```


\newpage

# Bootstrapped 95% confidence intervals

## Create a bootstrap function

This functions creates a main element, the `data_dens` data frame. It stores the bootstrapped samples of means as they are calculated using the bias-corrected and accelerated (Bca) method. These are later used to plot density graphs that compare bootstrapped distributions of pre-and post-treatment symptoms.
```{r}
boot_funs <- function(df, f1, f2){
            a <- df[[f1]]
            b <- df[[f2]]
            boot_a <- boot(a,
                           function(x, j) mean(x[j], na.rm = T), #Boot baseline variable
                           R = 10000)
            boot_b <- boot(b,
                           function(x, j) mean(x[j], na.rm = T), #Boot 7 days variable
                           R = 10000)
            boot_ci_a <- boot.ci(boot.out = boot_a, #Calculate baseline CI
                                 conf = 0.95,
                                 type = "bca")
            boot_ci_b <- boot.ci(boot.out = boot_b, #Calculate post-treatment CI
                                 conf = 0.95,
                                 type = "bca")
            print(boot_ci_a) # Return baseline bootstrapped CI
            print(boot_ci_b) # Return post-treatment bootstrapped CI
            
            ## Code to extract bootstrapped sample means
            densitiy_a <- boot_a$t
            densitiy_b <- boot_b$t
            dens <- c(densitiy_a, densitiy_b)
            time <- rep(c("Baseline", "Post-Treatment"), each = 10000)
            data_dens <<- data.frame(dens, time)
            data_dens$time <- factor(data_dens$time)
}
```



\newpage
## Run bootstraps and create ggplot graph objects

### Bootstrap - MADRS total score
```{r}
### Bootstrap CI - MADRS total score
boot_funs(df, "MADRS_pré", "MADRS_24h")

plot_madrs <- ggplot(data_dens)+
            geom_density(aes(x = dens, fill = time),
                         color = "white",
                         alpha = 0.9)+
            labs(x = "Total MADRS scores")+
            scale_fill_brewer(name = "Time of assessment:",
                              palette = "Dark2")+
  theme_classic()+
  theme(text = element_text(family = "serif"),
        axis.text.x = element_text(size = 14),
        axis.title.x = element_text(size = 14),
        axis.text.y = element_text(size = 14),
        axis.title.y = element_text(size = 14),
        legend.text = element_text(size = 13),
        legend.title = element_text(size = 13)) ##ggplot2 graph
```
\newpage
### Bootstrap - MADRS item 10

```{r}
### Bootstrap CI - MADRS item 10

boot_funs(df, "Item10_PréMADRS", "Item10_24hMADRS")

plot_madrs10 <- ggplot(data_dens)+
            geom_density(aes(x = dens, fill = factor(time)),
                         color = "white",
                         alpha = 0.9)+
            labs(x = "Item 10 MADRS scores",
                 y = element_blank())+
            scale_fill_brewer(name = "Time of assessment:",
                              palette = "Dark2")+
  theme_classic()+
  theme(text = element_text(family = "serif"),
        axis.text.x = element_text(size = 14),
        axis.title.x = element_text(size = 14),
        axis.text.y = element_text(size = 14),
        axis.title.y = element_text(size = 14),
        legend.text = element_text(size = 13),
        legend.title = element_text(size = 13)) ##ggplot2 graph


```

\newpage
# Graphics

This first part creates an annotated plot using the `ggplot2` density plots for the bootstrapped sample means and the `patchwork` package.
```{r}
## Density plots of bootstrapped sample means

## Creates patchwork object
graficos <- plot_madrs + plot_madrs10 &
            theme(legend.position = "bottom",
                  text = element_text(family = "serif"),
                  title = element_text(size = 12),
                  legend.title = element_text(size = 12))

## Creates guided patchwork object
graficos_f <- graficos + plot_layout(guides = "collect")

## Edits and annotates patchwork object
plota <- graficos_f + plot_annotation(
            title = 'Supp. Fig. 1 - Bootstraped sample means for total and item 10 MADRS scores',
            subtitle = 'Density plots of results at baseline and 24 hours post-treatment')

## Saves plot in high resolution
ggsave("density_plot.png", plota, width=25, height=15, units="cm", dpi=450)
```

|

This next part uses a long formatted dataset to compare pre-and post-infusion results for each patient.
```{r}
## Create dataset for total MADRS scores
madrs_total <- c(df$MADRS_pré, df$MADRS_24h)
time <- rep(c("baseline", "post"), each = 10)
id <- rep(1:10, 2)
id <- factor(id)
madrs_data_plot <- tibble(id, time, madrs_total)

## plot total MADRS scores
madrs_plot <- madrs_data_plot %>% ggplot()+
            geom_boxplot(aes(x = time, y = madrs_total),
                         width = .3,
                         alpha = .3,
                         color = "grey")+
            scale_y_continuous(breaks = seq(from = 10,
                                            to = 50,
                                            by = 5))+
            scale_x_discrete(labels = c("Baseline", "24 hours post-infusion"))+
            geom_point(aes(x = time, y = madrs_total,
                           color = id,
                           group = id),
                       size = 1.5)+
            geom_line(aes(x = time, y = madrs_total,
                          color = id,
                          group = id,
                          alpha = .4),
                      size = 1.5)+
            scale_color_npg()+
            theme_classic()+
            labs(x = "Time of assessment",
                 y = "Total MADRS scores")+
            theme(axis.title.x = element_text(size = 14),
                  axis.text.x = element_text(size = 13),
                  axis.title.y = element_text(size = 15),
                  axis.text.y = element_text(size = 13),
                  legend.position = "none")

## Create dataset for MADRS Item 10

si_pre <- df$Item10_PréMADRS
si_post <- df$Item10_24hMADRS

madrs_item10 <- c(si_pre, si_post)
time <- rep(c("baseline", "post"), each = 10)
id <- rep(1:10, 2)
id <- factor(id)
madrs_item_plot <- tibble(id, time, madrs_item10)

item10_plot <- madrs_item_plot %>% ggplot()+
            geom_boxplot(aes(x = time, y = madrs_item10),
                         width = .3,
                         alpha = .3,
                         color = "grey")+
            scale_y_continuous(breaks = seq(from = 0,
                                            to = 6,
                                            by = 1))+
            scale_x_discrete(labels = c("Baseline", "24 hours post-infusion"))+
            geom_point(aes(x = time, y = madrs_item10,
                           color = id,
                           group = id),
                       size = 1.5,
                       position = position_dodge(0.08))+
            geom_line(aes(x = time, y = madrs_item10,
                          color = id,
                          group = id,
                          alpha = .4),
                      size = 1.5,
                       position = position_dodge(0.08))+
            scale_color_npg()+
            theme_classic()+
            labs(x = "Time of assessment",
                 y = "MADRS item 10 scores")+
            theme(axis.title.x = element_text(size = 14),
                  axis.text.x = element_text(size = 13),
                  axis.title.y = element_text(size = 15),
                  axis.text.y = element_text(size = 13),
                  legend.position = "none",
                  text = element_text(family = "serif"))

```
## Join and save plots

```{r, message = F, warning= F}
## Creates patchwork object
graficos_i10 <- madrs_plot + item10_plot &
            theme(text = element_text(family = "serif"),
                  title = element_text(size = 16),
                  legend.title = element_text(size = 14))

## Edits and annotates patchwork object
graficos_i10 <- graficos_i10 + plot_annotation(
            title = 'Total and item 10 MADRS scores at baseline and 24h post-treatment',
            subtitle = 'Scores are given for each patient')

## Saves plot in high resolution
ggsave("MADRS_plot.png", graficos_i10, width=25, height=15, units="cm", dpi=500)
```


